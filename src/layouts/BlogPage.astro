---
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Header from '../components/Header.astro';
import SeriesTOC from '../components/SeriesTOC.astro';
import SeriesNav from '../components/SeriesNav.astro';
import { getCollection } from 'astro:content';
import '../styles/blog-page.css';

type Props = CollectionEntry<'blog'>['data'];

// Get all blog posts
const allPosts: CollectionEntry<'blog'>[] = await getCollection('blog');

// Recent posts (last 5)
const recentPosts = allPosts
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .slice(0, 7);

// Collect unique tags
const tagSet = new Set<string>();

for (const post of allPosts) {
  (post.data.tags || []).forEach((tag: string) => tagSet.add(tag));
}
const allTags = Array.from(tagSet).sort();

const { title, author, description, tags, pubDate, updatedDate, heroImage, series } = Astro.props;
---

<html lang="en">
	<head>
		<BaseHead title={title} description={description} image={heroImage} />
  </head>

	<body>
		<Header />
    <main class="container mx-auto">
      <!-- Hero -->
      {heroImage && (
        <div class="hero-image lg:px-32 mb-6">
          <Image width={1280} height={640} src={heroImage} alt={title} class="rounded-lg" />
        </div>
      )}

      <!-- Title & Meta -->
      <header class="mb-10 py-10 text-center">
        <h1 class="text-3xl lg:text-5xl font-serif font-bold tracking-tight">{title}</h1>

        <div class="mt-4 flex flex-wrap justify-center items-center gap-x-2 text-sm text-gray-500">
          <span class="text-gray-600">
            By <span class="font-medium text-gray-900">{author || 'Notivra Team'}</span>
          </span>
          <span class="hidden sm:inline">Â·</span>
          <span>
            <FormattedDate date={pubDate} />
            {updatedDate && (
              <span> (updated <FormattedDate date={updatedDate} />)</span>
            )}
          </span>
        </div>

        {tags && tags.length > 0 && (
          <div class="mt-4 flex flex-wrap justify-center gap-2">
            {tags.map(tag => (
              <span class="px-3 py-1 text-xs font-semibold uppercase tracking-wide bg-indigo-100 text-indigo-700 rounded-full">
                {tag}
              </span>
            ))}
          </div>
        )}

        <hr class="mt-10 border-gray-200" />
      </header>

      <!-- Grid layout -->
      <div class="relative grid grid-cols-1 lg:grid-cols-12 gap-8">
        <aside class="hidden md:block space-y-8 lg:col-span-2 my-8 lg:mt-6 mx-8 sm:mx-12 lg:mx-auto">
          <section>
            <h2 class="text-2xl font-semibold">Categories</h2>
            <div class="flex flex-wrap gap-2 mt-2">
              {allTags.map((tag) => (
                <a
                href={`/tags/${tag}/page/1`}
                  class="px-2 py-1 text-sm rounded bg-gray-100 text-gray-700 hover:bg-gray-200 transition"
                >
                  {tag}
                </a>
              ))}
           </div>
          </section>
        </aside>

        <article class="prose lg:col-span-7">
          <slot />
          <SeriesNav {...Astro.props} />
        </article>

        <aside class="space-y-8 lg:col-span-3 my-8 lg:mt-6 mx-8 sm:mx-12 lg:mx-auto">
          {series && (
          <div class="md:sticky top-16 bg-white/80">
              <SeriesTOC {...Astro.props} />
              <hr class="mt-10 border-gray-200" />
            </div>
          )}
          <section>
            <h2 class="text-2xl font-semibold">Recent Posts</h2>
              <ul class="text-sm leading-5 space-y-3">
                {recentPosts.map((post) => (
                  <li class="flex flex-col">
                    <a href={`/${post.id}/`} class="hover:underline">
                      {post.data.title}
                    </a>
                    <span><FormattedDate date={post.data.pubDate}/></span>
                  </li>
                ))}
            </ul>
          </section>
          <hr class="mt-10 border-gray-200" />
          <section class="md:hidden">
            <h2 class="text-2xl font-semibold">Categories</h2>
            <div class="flex flex-wrap gap-2 mt-2">
              {allTags.map((tag) => (
                <a
                href={`/tags/${tag}/page/1`}
                  class="px-2 py-1 text-sm rounded bg-gray-100 text-gray-700 hover:bg-gray-200 transition"
                >
                  {tag}
                </a>
              ))}
            </div>
          </section>
        </aside>
      </div>
    </main>
    <Footer />
	</body>
</html>
