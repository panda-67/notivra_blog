---
export type Heading = {
  depth: number;
  slug: string;
  text: string;
};

interface Props {
  headings: Heading[];
  minDepth?: number;
  maxDepth?: number;
  title?: string;
}

const {
  headings,
  minDepth = 2,
  maxDepth = 3,
  title = 'On this page',
} = Astro.props;

const toc = headings.filter(
  (h) => h.depth >= minDepth && h.depth <= maxDepth
);
---

{toc.length > 0 && (
  <nav class="post-toc">
    <h3
      class="toc-title text-2xl font-semibold !mb-1.5 cursor-pointer select-none flex items-center gap-2"
      onclick="this.nextElementSibling.classList.toggle('open')"
    >
      <span>{title}</span>
      <span class="toc-indicator">▾</span>
    </h3>

    <ol class="toc-list list-decimal list-outside space-y-1 text-sm px-3">
      {toc.map((h) => (
        <li class={h.depth > minDepth ? 'ml-4 text-slate-400' : 'text-slate-300'}>
          <a
            href={`#${h.slug}`}
            data-toc-link={h.slug}
            class="hover:text-indigo-400"
          >
            {h.text}
          </a>
        </li>
      ))}
    </ol>
  </nav>
)}

<style>
  .post-toc .toc-list {
    max-height: 0;
    margin-bottom: 0;
    overflow: hidden;
    transition: max-height 600ms ease, margin-top 300ms ease, margin-bottom 600ms ease;
  }

  .post-toc .toc-list.open {
    max-height: 1000px; /* exceeds worst-case height */
    margin-top: 18px;
    margin-bottom: 32px;
  }

  @media (prefers-reduced-motion: reduce) {
    .post-toc .toc-list {
      transition: none;
    }
  }

  .post-toc .toc-indicator {
    display: inline-block;
    transition: transform 600ms ease;
    transform: rotate(-90deg); /* closed */
  }

  .post-toc .toc-list.open ~ .toc-title .toc-indicator,
  .post-toc .toc-title:has(+ .toc-list.open) .toc-indicator {
    transform: rotate(0deg); /* open */
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const headings = [...document.querySelectorAll('article h2[id], article h3[id]')];
    const links = [...document.querySelectorAll('[data-toc-link]')];

    if (!headings.length) {
      console.warn('TOC: no headings found');
      return;
    }

    const setActive = (id:any) => {
      links.forEach(link => {
        const active = link.dataset.tocLink === id;
        link.classList.toggle('text-indigo-400', active);
        link.classList.toggle('font-semibold', active);
        link.classList.toggle('text-slate-400', !active);
      });
    };

    // 1️⃣ Highlight immediately on TOC click
    document.querySelectorAll('[data-toc-link]').forEach(link => {
      link.addEventListener('click', () => {
        setActive(link.dataset.tocLink);
      });
    });

    // 2️⃣ Highlight on direct hash navigation / reload
    window.addEventListener('hashchange', () => {
      const id = location.hash.replace('#', '');
      if (id) setActive(id);
    });

    // 3️⃣ Highlight on initial load (if URL has hash)
    if (location.hash) {
      setActive(location.hash.replace('#', ''));
    }

    const observer = new IntersectionObserver(
      (entries) => {
        const visible = entries
          .filter(e => e.isIntersecting)
          .sort((a, b) => a.boundingClientRect.top - b.boundingClientRect.top);

        if (visible.length) {
          setActive(visible[0].target.id);
        }
      },
      {
        rootMargin: '-25% 0px -60% 0px',
        threshold: 0,
      }
    );

    headings.forEach(h => observer.observe(h));
  });
</script>

